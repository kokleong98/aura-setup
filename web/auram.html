<!DOCTYPE html>
<html lang="en">
<head>
  <title>Aura monitor</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
  <script>

    function humanRead(value){
      return (value < 60) ? (value + " min(s)") : (value / 60).toFixed(2) + " hour(s)";
    }

    function clearCanvas(id, msg){
      var canvas = document.getElementById(id);
      var ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = "30px Arial";
      ctx.textAlign = "center";
      if(msg.length > 0) ctx.fillText(msg, canvas.width / 2, canvas.height / 2);
    }

    function insertTableRow(id, index, result){
      var table = document.getElementById(id);
      var row = table.insertRow(index);
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      var d = new Date(result.Date);
      cell1.innerHTML = d.getUTCFullYear() + "-" + (d.getUTCMonth()+1) + "-" + d.getUTCDate();
      cell2.innerHTML = result.Online;
      cell2.innerHTML = result.Offline;
    }

    function downloadData(uri, func){
      return $.getJSON(uri).then(func);
    }

    function buildChart(data){
      var d = new Date();
      var mo = ("0" + (d.getUTCMonth()+1));
      mo = mo.length > 2 ? mo.slice(1) : mo;
      var date = ("0" + d.getUTCDate());
      date = date.length > 2 ? date.slice(1) : date;
      var today = d.getUTCFullYear() + "-" + mo + "-" + date;

      $("#txtOn").html(humanRead(data.Online) + " (" + ((data.Online / data.Est)*100).toFixed(4)  + "%)");
      $("#txtOff").html(humanRead(data.Offline) + " (" + ((data.Offline / data.Est)*100).toFixed(4) + "%)");
      $("#txtOth").html(humanRead(data.Miss + data.NoStatus) + " (" + (((data.Miss + data.NoStatus)/data.Est)*100).toFixed(4) + "%)");
      $("#dayprogress").css("width", ((data.Est / 1440)*100).toFixed(2) + "%");
      $("#curDay").html(today);
      $("#dayprogress").html(((data.Est / 1440)*100).toFixed(2) + "%");
      var mydata = [data.Online,data.Offline,data.Miss + data.NoStatus];

      var ctx = document.getElementById('myChart').getContext('2d');
      var myDoughnutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ["Online", "Offline", "Others"],
          datasets: [
            {
              label: "Node status (minutes)",
              backgroundColor: ["lawngreen", "Red","Orange"],
              data: mydata
            }
          ]
        },
        options: {
          title: {
            display: true,
            text: 'Node staking status (minutes)'
          },
          circumference: Math.PI,
          rotation: -Math.PI,
          animation: {
            animateScale: false
          }	
        }
      });
    }

    function handleChartData(){
      var d = new Date();
      var mo = ("0" + (d.getUTCMonth()+1));
      mo = mo.length > 2 ? mo.slice(1) : mo;
      var date = ("0" + d.getUTCDate());
      date = date.length > 2 ? date.slice(1) : date;
      var uri = "data/stat_" + d.getUTCFullYear() + "_" + mo + "_" + date + ".json";
      clearCanvas("myChart", "Loading Data.");
      downloadData(uri, buildChart);
    }

    $(document).ready(function(){
      clearCanvas("myChart", "No Data.");
      handleChartData();
      setInterval(handleChartData, 60000);
    });
  </script>
  <style>
    .nav-tabs>li>a {
      background-color: transparent;
      border-color: transparent;
      color: #FFFFFF;
    }
  </style>
</head>
<body>
 
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <a class="navbar-brand" href="#"><i class="fas fa-desktop"></i> AURA-M</i></a>
    <ul class="nav nav-tabs">
      <li class="nav-item  bg-dark navbar-dark">
        <a class="nav-link active" data-toggle="tab" href="#status"  onclick="handleChartData()"><i class="fas fa-wifi"></i> Now</a>
      </li>
      <li class="nav-item bg-dark navbar-dark">
        <a class="nav-link" data-toggle="tab" href="#history"><i class="fas fa-history" id=""></i> Past</a>
      </li>
      <li class="nav-item bg-dark navbar-dark">
        <a class="nav-link" data-toggle="tab" href="#about"><i class="fas fa-code"></i> About</a>
      </li>    
    </ul>
  </nav>

  <div class="tab-content">
      <div id="status" class="container tab-pane active">
        <div class="container-fluid">
          <div class="row">
            <div class="col-sm">
              <canvas id="myChart" height="225"></canvas>
            </div>
          </div>
          <div class="row justify-content-center">
              <i class="far fa-calendar-alt pt-1"></i> <code class="text-dark" id="curDay">no data.</code>
          </div>
          <div class="row">
            <div class="col-sm">
              <div class="progress" style="height:20px">
                <div class="progress-bar" id="dayprogress" style="width:0%;height:20px">no data.</div>
              </div>
            </div>
          </div>
          <div class="row justify-content-center pt-1">
              <div class="bg-success text-white text-center pr-2 pl-2 small" id="txtOn" style="height:20px">no data.</div>
              <div class="bg-danger text-white text-center pr-2 pl-2 small" id="txtOff" style="height:20px">no data.</div>
              <div class="bg-warning text-white text-center pr-2 pl-2 small" id="txtOth" style="height:20px">no data.</div>
          </div>
          
          <div class="row pt-1">
              <table class="table table-sm table-hover" id="logs">
                <thead class="thead-dark">
                  <tr>
                    <th>Time</th>
                    <th>Event</th>
                    <th>Range</th>
                  </tr>
                </thead>
                <tbody id="lbody">
                </tbody>
              </table>
          </div>
        </div>
      </div>
      <div id="history" class="container tab-pane fade"><br>
        <p>Past data to display here.</p>
      </div>
      <div id="about" class="container tab-pane fade"><br>
        <div id="aboutcard">
          <div class="card">
            <div class="card-header" id="appinfo">
              <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"><i class="fas fa-info-circle"></i> AURA-M</button>
            </div>
        
            <div id="collapseOne" class="collapse show" aria-labelledby="appinfo" data-parent="#aboutcard">
              <div class="card-body">
                <p>This is an add-on dashboard to Aura monitoring service and require statistics collection and post process to be turn-on.</p>
                <p>Source: <a href="https://github.com/kokleong98/aura-setup/"><i class="fab fa-github fa-2x"></i> GitHub</a></p>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="authorinfo">
              <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo"><i class="fas fa-at"></i> Author</button>
              </h5>
            </div>
          
            <div id="collapseTwo" class="collapse" aria-labelledby="authorinfo" data-parent="#aboutcard">
              <div class="card-body">
                <table class="table table-bordered table-striped text-center">
                  <thead align="center">Author: Soo Kok Leong</thead>
                  <tr>
                    <td colspan="2" align="center"><img width="100" height="100" src="https://cdn.discordapp.com/avatars/432384295450050560/0ed9aa6ca18236ad006bd9bc535e4e46.png"></td>
                  </tr>
                  <tr>
                      <td align="center"><a href="https://www.linkedin.com/in/soo-kok-leong-a6634842/"><i class="fab fa-linkedin fa-2x"></i> LinkedIn</a></td>
                      <td align="center"><a href="https://discordapp.com/channels/432384295450050560/"><i class="fab fa-discord fa-2x"></i> Discord</a></td>
                    </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</body>
</html>
